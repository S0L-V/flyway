<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.flyway.admin.mapper.StatisticsMapper">

    <!-- ResultMap -->
    <resultMap id="statisticsResultMap" type="com.flyway.admin.dto.StatisticsDto">
        <result property="statId" column="stat_id"/>
        <result property="statType" column="stat_type"/>
        <result property="statDate" column="stat_date"/>
        <result property="totalReservations" column="total_reservations"/>
        <result property="confirmedReservations" column="confirmed_reservations"/>
        <result property="cancelledReservations" column="cancelled_reservations"/>
        <result property="totalRevenue" column="total_revenue"/>
        <result property="averageTicketPrice" column="average_ticket_price"/>
        <result property="totalRefunds" column="total_refunds"/>
        <result property="refundCount" column="refund_count"/>
        <result property="newUsers" column="new_users"/>
        <result property="activeUsers" column="active_users"/>
        <result property="calculatedAt" column="calculated_at"/>
    </resultMap>

    <!-- 통계 저장 (INSERT OR UPDATE) -->
    <insert id="upsertStatistics" parameterType="com.flyway.admin.dto.StatisticsDto">
        INSERT INTO statistics (
            stat_id,
            stat_type,
            stat_date,
            total_reservations,
            confirmed_reservations,
            cancelled_reservations,
            total_revenue,
            average_ticket_price,
            total_refunds,
            refund_count,
            new_users,
            active_users,
            calculated_at
        ) VALUES (
            #{statId},
            #{statType},
            #{statDate},
            #{totalReservations},
            #{confirmedReservations},
            #{cancelledReservations},
            #{tatlRevenue},
            #{averagTicketPrice},
            #{totalRefunds},
            #{refundCount},
            #{newUsers},
            #{activeUsers},
            NOW()
        )
        ON DUPLICATE KEY_UPDATE
            total_reservations = VALUES(total_reservations),
            confirmed_reservations = VALUES(confirmed_reservations),
            cancelled_reservations = VALUES(cancelled_reservations),
            total_revenue = VALUES(total_revenue),
            average_ticket_price = VALUES(average_ticket_price),
            total_refunds = VALUES(total_refunds),
            refund_count = VALUES(refund_count),
            new_users = VALUES(new_users),
            active_users = VALUES(active_users),
            calculated_at = NOW()
    </insert>

    <!-- 특정 날짜/유형의 통계 조회 -->
    <select id="selectStatistics" resultMap="statisticsResultMap">
        SELECT *
        FROM statistics
        WHERE stat_type = #{statType}
            AND stat_date = #{statDate}
        LIMIT 1
    </select>

    <!-- 기간별 통계 목록 조회 -->
    <select id="selectStatisticsByPeriod" resultMap="statisticsResultMap">
        SELECT *
        FROM statistics
        WHERE stat_type = #{statType}
            AND stat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY stat_date DESC
    </select>

    <!-- 최근 N일간 일일 통계 조회 -->
    <select id="selectRecentDailyStatistics" resultMap="statisticsResultMap">
        SELECT *
        FROM statistics
        WHERE stat_type = 'DAILY'
            AND stat_date >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        ORDER BY stat_date DESC
    </select>

    <!-- ========================================== -->
    <!-- 통계 계산용 쿼리 (원본 테이블에서 집계) -->
    <!-- ========================================== -->

    <!-- 총 예약 건수 -->
    <select id="countReservationsByPeriod" resultType="int">
        SELECT COUNT(*)
        FROM reservation
        WHERE DATE (reserved_at) BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 총 예약 건수 (결제 완료) -->
    <select id="countConfirmedReservationsByPeriod" resultType="int">
        SELECT COUNT(*)
        FROM reservation r
        JOIN payment p ON r.reservation_id = p.reservation_id
        WHERE DATE(r.reserved_at) BETWEEN #{startDate} AND #{endDate}
            AND p.status = 'PAID'
    </select>

    <!-- 취소/환불 예약 건수 -->
    <select id="countCancelledReservationsByPeriod" resultType="int">
        SELECT COUNT(DISTINCT r.reservation_id)
        FROM reservation r
                 JOIN refund rf ON r.reservation_id = rf.reservation_id
        WHERE DATE(rf.requested_at) BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 총 매출 -->
    <select id="sumRevenueByPeriod" resultType="long">
        SELECT COALESCE(SUM(amount), 0)
        FROM payment
        WHERE DATE(paid_at) BETWEEN #{startDate} AND #{endDate}
            AND status = 'PAID'
    </select>

    <!-- 평균 티켓 가겨 -->
    <select id="avgTicketPriceByPeriod" resultType="long">
        SELECT COALESCE(AVG(amount), 0)
        FROM payment
        WHERE DATE (paid_at) BETWEEN #{startDate} AND #{endDate}
            AND status = 'PAID'
    </select>

    <!-- 환불 건수 -->
    <select id="countRefundsByPeriod" resultType="int">
        SELECT COUNT(*)
        FROM refund
        WHERE DATE(requested_at) BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 총 환불 금액 -->
    <select id="sumRefundsByPeriod" resultType="long">
        SELECT COALESCE(SUM(refund_amount), 0)
        FROM refund
        WHERE DATE(requested_at) BETWEEN #{startDate} AND #{endDate}
            AND refund_status = 'APPROVED'
    </select>

    <!-- 신규 가입 회원 수 -->
    <select id="countNewUsersByPeriod" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE DATE(created_at) BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 활성 사용자 수 (방문자) -->
    <select id="countActiveUsersByPeriod" resultType="int">
        SELECT COUNT(DISTINCT session_id)
        FROM visitor_log
        WHERE DATE(visited_at) BETWEEN #{startDate} AND #{endDate}
    </select>
</mapper>