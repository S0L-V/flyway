<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.flyway.admin.mapper.AdminPaymentMapper">

    <select id="countPaidPayments" resultType="long">
        SELECT COUNT(*)
        FROM payment
        WHERE status = 'PAID'
    </select>

    <select id="countPendingPayments" resultType="long">
        SELECT COUNT(*)
        FROM payment
        WHERE status = 'PENDING'
    </select>

    <select id="countRefundedPayments" resultType="long">
        SELECT COUNT(*)
        FROM payment
        WHERE status IN ('REFUNDED', 'CANCELLED')
    </select>

    <select id="sumMonthlyRevenue" resultType="long">
        SELECT COALESCE(SUM(amount), 0)
        FROM payment
        WHERE status = 'PAID'
            AND YEAR(paid_at) = YEAR(CURDATE())
          AND MONTH(paid_at) = MONTH(CURDATE())
    </select>

    <resultMap id="paymentListResultMap" type="com.flyway.admin.dto.PaymentListDto">
        <result property="paymentId" column="payment_id"/>
        <result property="reservationId" column="reservation_id"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="amount" column="amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="paidAt" column="paid_at"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userEmail" column="user_email"/>
        <result property="flightNumber" column="flight_number"/>
        <result property="route" column="route"/>
    </resultMap>

    <select id="selectPaymentList" resultMap="paymentListResultMap">
        SELECT
        p.payment_id,
        p.reservation_id,
        p.transaction_id,
        p.amount,
        p.payment_method,
        p.status,
        p.created_at,
        p.paid_at,
        u.user_id,

        -- [수정] up.name을 우선 사용하고 (빈 문자열은 NULL 처리), 없으면 first/last_name 조합
        COALESCE(NULLIF(up.name, ''), NULLIF(CONCAT_WS(' ', up.first_name, up.last_name), '')) AS user_name,

        u.email AS user_email,
        f.flight_number,

        -- [수정] 출발/도착 공항 중 하나라도 없으면 이상한 화살표 대신 NULL 반환
        CASE
        WHEN dep.airport_id IS NOT NULL AND arr.airport_id IS NOT NULL
        THEN CONCAT(dep.airport_id, ' → ', arr.airport_id)
        ELSE NULL
        END AS route

        FROM payment p
        LEFT JOIN reservation r ON p.reservation_id = r.reservation_id
        LEFT JOIN users u ON r.user_id = u.user_id
        LEFT JOIN user_profile up ON u.user_id = up.user_id
        LEFT JOIN reservation_segment rs ON r.reservation_id = rs.reservation_id AND rs.segment_order = 1
        LEFT JOIN flight f ON rs.flight_id = f.flight_id
        LEFT JOIN airport dep ON f.departure_airport = dep.airport_id
        LEFT JOIN airport arr ON f.arrival_airport = arr.airport_id
        <where>
            <if test="status != null and status != ''">
                AND p.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                up.name LIKE CONCAT('%', #{keyword}, '%')
                OR up.first_name LIKE CONCAT('%', #{keyword}, '%')
                OR up.last_name LIKE CONCAT('%', #{keyword}, '%')
                OR u.email LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY p.paid_at DESC, p.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countPayments" resultType="long">
        SELECT COUNT(*)
        FROM payment p
        LEFT JOIN reservation r ON p.reservation_id = r.reservation_id
        LEFT JOIN users u ON r.user_id = u.user_id
        LEFT JOIN user_profile up ON u.user_id = up.user_id
        <where>
            <if test="status != null and status != ''">
                AND p.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                up.name LIKE CONCAT('%', #{keyword}, '%')
                OR up.first_name LIKE CONCAT('%', #{keyword}, '%')
                OR up.last_name LIKE CONCAT('%', #{keyword}, '%')
                OR u.email LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </select>

</mapper>