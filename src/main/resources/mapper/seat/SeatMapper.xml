<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.flyway.seat.mapper.SeatMapper">

    <!-- 만료된 HOLD 좌석을 AVAILABLE로 복구 -->
    <update id="releaseExpiredHolds">
        UPDATE flight_seat
        SET seat_status = 'AVAILABLE',
            hold_expires_at = NULL
        WHERE seat_status = 'HOLD'
          AND hold_expires_at IS NOT NULL
          AND hold_expires_at &lt; NOW()
    </update>

    <!-- 항공편별 좌석 맵 조회 -->
    <select id="selectSeatMapByFlightId" resultType="com.flyway.seat.dto.SeatDTO">
        SELECT
            fs.flight_seat_id   AS flightSeatId,
            fs.flight_id        AS flightId,
            a.seat_no           AS seatNo,
            a.row_no            AS rowNo,
            a.col_no            AS colNo,
            a.cabin_class_code  AS cabinClassCode,
            fs.seat_status      AS seatStatus,
            fs.hold_expires_at  AS holdExpiresAt
        FROM flight_seat fs
                 JOIN aircraft_seat a
                      ON fs.aircraft_seat_id = a.airplane_seat_id
        WHERE fs.flight_id = #{flightId}
        ORDER BY a.cabin_class_code, a.row_no, a.col_no
    </select>

</mapper>
