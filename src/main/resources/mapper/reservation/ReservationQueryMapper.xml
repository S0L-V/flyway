<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.flyway.reservation.mapper.ReservationQueryMapper">

    <!-- 유저 예약 내역 목록 조회  -->
    <select id="findReservationHistoriesByUserId"
            parameterType="string"
            resultType="com.flyway.reservation.dto.ReservationSummaryDto">

        SELECT
            r.reservation_id                           AS reservationId,
            r.status                                   AS reservationStatus,
            r.reserved_at                              AS reservedAt,

            pay.amount                                 AS paidAmount,

            -- 가는 편 (segment_order = 1)
            MAX(CASE WHEN rs.segment_order = 1 THEN rs.flight_id END)        AS outFlightId,
            MAX(CASE WHEN rs.segment_order = 1 THEN f.departure_airport END) AS outDepartureAirport,
            MAX(CASE WHEN rs.segment_order = 1 THEN dep.city END)            AS outDepartureCity,
            MAX(CASE WHEN rs.segment_order = 1 THEN f.arrival_airport END)   AS outArrivalAirport,
            MAX(CASE WHEN rs.segment_order = 1 THEN arr.city END)            AS outArrivalCity,
            MAX(CASE WHEN rs.segment_order = 1 THEN f.departure_time END)    AS outDepartureTime,
            MAX(CASE WHEN rs.segment_order = 1 THEN f.arrival_time END)      AS outArrivalTime,

            -- 오는 편 (segment_order = 2)
            MAX(CASE WHEN rs.segment_order = 2 THEN rs.flight_id END)        AS inFlightId,
            MAX(CASE WHEN rs.segment_order = 2 THEN f.departure_airport END) AS inDepartureAirport,
            MAX(CASE WHEN rs.segment_order = 2 THEN dep.city END)            AS inDepartureCity,
            MAX(CASE WHEN rs.segment_order = 2 THEN f.arrival_airport END)   AS inArrivalAirport,
            MAX(CASE WHEN rs.segment_order = 2 THEN arr.city END)            AS inArrivalCity,
            MAX(CASE WHEN rs.segment_order = 2 THEN f.departure_time END)    AS inDepartureTime,
            MAX(CASE WHEN rs.segment_order = 2 THEN f.arrival_time END)      AS inArrivalTime

        FROM reservation r
                 JOIN reservation_segment rs
                      ON rs.reservation_id = r.reservation_id
                 JOIN flight f
                      ON f.flight_id = rs.flight_id
                 JOIN airport dep
                      ON dep.airport_id = f.departure_airport
                 JOIN airport arr
                      ON arr.airport_id = f.arrival_airport

                 LEFT JOIN (
            -- 예약별 최신 'PAID' 결제 1건 (없는 경우 NULL)
            SELECT p1.reservation_id, p1.amount
            FROM payment p1
                     JOIN (
                SELECT reservation_id, MAX(paid_at) AS max_paid_at
                FROM payment
                WHERE status = 'PAID'
                GROUP BY reservation_id
            ) pm
                          ON pm.reservation_id = p1.reservation_id
                              AND pm.max_paid_at = p1.paid_at
        ) pay
                           ON pay.reservation_id = r.reservation_id

        WHERE r.user_id = #{userId}

        GROUP BY
            r.reservation_id,
            r.status,
            r.reserved_at,
            pay.amount

        ORDER BY r.reserved_at
    </select>

    <!-- 사용자 예약 내역 전체 건수 조회  -->
    <select id="countReservationHistoriesByUserId" resultType="int">
        SELECT COUNT(*)
        FROM reservation r
        WHERE r.user_id = #{userId}
    </select>

</mapper>
