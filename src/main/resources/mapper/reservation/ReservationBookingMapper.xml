<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.flyway.reservation.mapper.ReservationBookingMapper">

    <!-- booking 페이지 상단 헤더 -->
    <select id="selectReservationHeader" parameterType="string"
            resultType="com.flyway.reservation.dto.BookingViewModel">
        SELECT
            reservation_id AS reservationId,
            passenger_count AS passengerCount,
            status AS status,
            trip_type AS tripType,
            expired_at AS expiredAt
        FROM reservation
        WHERE reservation_id = #{reservationId}
    </select>

    <!-- 본인 예약만 조회 -->
    <select id="selectReservationHeaderByUser"
            resultType="com.flyway.reservation.dto.BookingViewModel">
        SELECT
            reservation_id AS reservationId,
            passenger_count AS passengerCount,
            status AS status,
            trip_type AS tripType,
            expired_at AS expiredAt
        FROM reservation
        WHERE reservation_id = #{reservationId}
          AND user_id = #{userId}
    </select>

    <!-- 예약 구간 스냅샷 -->
    <select id="selectReservationSegments" parameterType="string"
            resultType="com.flyway.reservation.dto.ReservationSegmentView">
        SELECT
            reservation_segment_id AS reservationSegmentId,
            segment_order AS segmentOrder,
            snap_departure_airport AS snapDepartureAirport,
            snap_arrival_airport AS snapArrivalAirport,
            snap_departure_time AS snapDepartureTime,
            snap_arrival_time AS snapArrivalTime,
            snap_flight_number AS snapFlightNumber,
            snap_cabin_class_code AS snapCabinClassCode,
            snap_price AS snapPrice,
            dep_ap.city AS snapDepartureCity,
            arr_ap.city AS snapArrivalCity,
            al.airline_name AS snapAirlineName
        FROM reservation_segment rs
        LEFT JOIN airport dep_ap ON rs.snap_departure_airport = dep_ap.airport_id
        LEFT JOIN airport arr_ap ON rs.snap_arrival_airport = arr_ap.airport_id
        LEFT JOIN airline al ON LEFT(rs.snap_flight_number, 2) = al.airline_id
        WHERE rs.reservation_id = #{reservationId}
        ORDER BY segment_order ASC
    </select>

    <!-- passenger 저장 완료 여부 -->
    <select id="countPassengers" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM passenger
        WHERE reservation_id = #{reservationId}
    </select>

    <!--  예약 row 잠금 -->
    <select id="lockReservationForUpdate" parameterType="string"
            resultType="com.flyway.reservation.dto.ReservationCoreView">
        SELECT
            reservation_id AS reservationId,
            user_id AS userId,
            passenger_count AS passengerCount,
            status AS status,
            expired_at AS expiredAt
        FROM reservation
        WHERE reservation_id = #{reservationId}
            FOR UPDATE
    </select>

    <!-- 탑승자 조회 -->
    <select id="selectPassengers" parameterType="string"
            resultType="com.flyway.passenger.dto.PassengerView">
        SELECT
            passenger_id AS passengerId,
            kr_first_name AS krFirstName,
            kr_last_name AS krLastName,
            first_name AS firstName,
            last_name AS lastName,
            birth AS birth,
            gender AS gender,
            email AS email,
            phone_number AS phoneNumber,
            passport_no AS passportNo,
            country AS country,
            passport_expiry_date AS passportExpiryDate,
            passport_issue_country AS passportIssueCountry
        FROM passenger
        WHERE reservation_id = #{reservationId}
        ORDER BY passenger_id ASC
    </select>

    <!-- 구간별 탑승자 좌석 조회 -->
    <select id="selectPassengerSeatsBySegment" parameterType="string"
            resultType="com.flyway.reservation.dto.PassengerSeatInfo">
        SELECT
            p.passenger_id AS passengerId,
            CONCAT(p.kr_last_name, p.kr_first_name) AS passengerName,
            aseat.seat_no AS seatNo
        FROM passenger_seat ps
                 JOIN passenger p ON ps.passenger_id = p.passenger_id
                 JOIN flight_seat fs ON ps.flight_seat_id = fs.flight_seat_id
                 JOIN aircraft_seat aseat ON fs.aircraft_seat_id = aseat.airplane_seat_id
        WHERE ps.reservation_segment_id = #{reservationSegmentId}
        ORDER BY aseat.row_no, aseat.col_no
    </select>

    <!-- 구간별 탑승자 부가서비스 조회 (수하물 + 기내식) -->
    <select id="selectPassengerServicesBySegment" parameterType="string"
            resultType="com.flyway.reservation.dto.PassengerServiceInfo">
        SELECT
            p.passenger_id AS passengerId,
            CONCAT(p.kr_last_name, p.kr_first_name) AS passengerName,
            ps.service_type AS serviceType,
            CASE
                WHEN ps.service_type = '1' THEN mo.meal_name
                ELSE CONCAT('추가 수하물 ', ps.quantity, '개')
                END AS serviceName,
            ps.quantity AS quantity,
            ps.total_price AS totalPrice
        FROM passenger_service ps
                 JOIN passenger p ON ps.passenger_id = p.passenger_id
                 LEFT JOIN meal_option mo ON ps.meal_id = mo.meal_id
        WHERE ps.reservation_segment_id = #{reservationSegmentId}
        ORDER BY ps.service_type, p.passenger_id
    </select>

    <!-- insert -->
    <insert id="insertPassenger" parameterType="com.flyway.passenger.dto.PassengerUpsertDTO">
        INSERT INTO passenger (
            passenger_id,
            reservation_id,
            kr_first_name,
            kr_last_name,
            first_name,
            last_name,
            passport_no,
            birth,
            country,
            gender,
            email,
            phone_number,
            passport_expiry_date,
            passport_issue_country
        ) VALUES (
            #{passengerId},
            #{reservationId},
            #{krFirstName},
            #{krLastName},
            #{firstName},
            #{lastName},
            #{passportNo},
            #{birth},
            #{country},
            #{gender},
            #{email},
            #{phoneNumber},
            #{passportExpiryDate},
            #{passportIssueCountry}
                 )
    </insert>

    <!-- update -->
    <update id="updatePassenger" parameterType="com.flyway.passenger.dto.PassengerUpsertDTO">
        UPDATE passenger
        SET
            kr_first_name = #{krFirstName},
            kr_last_name = #{krLastName},
            first_name = #{firstName},
            last_name = #{lastName},
            passport_no = #{passportNo},
            birth = #{birth},
            country = #{country},
            gender = #{gender},
            email = #{email},
            phone_number = #{phoneNumber},
            passport_expiry_date = #{passportExpiryDate},
            passport_issue_country = #{passportIssueCountry}
        WHERE passenger_id = #{passengerId}
          AND reservation_id = #{reservationId}
    </update>
    <update id="updateReservationStatus">
        UPDATE reservation
        SET status = #{status}
        WHERE reservation_id = #{reservationId}
    </update>


</mapper>
